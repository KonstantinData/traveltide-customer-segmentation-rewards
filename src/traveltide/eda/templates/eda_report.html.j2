{#
  EDA HTML report template (TT-012).

  Notes:
  - Standalone HTML for portability and easy review (GitHub, local browser, CI artifacts).
  - Keep structure simple: metadata → shapes → missingness → charts → previews.
  - Avoid external dependencies (CSS frameworks, images, JS) to keep output deterministic.
#}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <style>
      /* Notes: Minimal CSS for readability; no external assets for deterministic rendering. */
      body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.45; }
      h1, h2, h3 { margin: 0.6em 0 0.3em; }
      code, pre { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
      pre { padding: 12px; overflow-x: auto; }
      table { border-collapse: collapse; width: 100%; margin: 12px 0; }
      th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
      th { background: #f2f2f2; text-align: left; }
      .meta { background: #f6f8fa; padding: 12px; border-radius: 8px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .chart { border: 1px solid #eee; padding: 10px; border-radius: 8px; }
      .muted { color: #555; }
    </style>
  </head>
  <body>
    <h1>{{ title }}</h1>
    <p class="muted">
      Step 1 (EDA) artifact. This report documents cohort definition, data quality findings,
      preprocessing decisions, and core descriptive exploration.
    </p>

    <h2>Run metadata</h2>
    <div class="meta">
      <!-- Notes: Metadata is displayed verbatim to keep the run fully auditable. -->
      <pre>{{ metadata | tojson(indent=2) }}</pre>
    </div>

    <h2>EDA workflow</h2>
    <p class="muted"><strong>{{ workflow.name }}</strong> — {{ workflow.description }}</p>
    <ol>
      {% for step in workflow_steps %}
        <li>
          <strong>{{ step.title }}</strong> <span class="muted">({{ step.id }})</span>
          <div class="muted">{{ step.purpose }}</div>
          <div class="muted">{{ step.note }}</div>
          {% if step.outputs %}
            <ul>
              {% for output in step.outputs %}
                <li>{{ output }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% endfor %}
    </ol>

    <h2>Data overview</h2>
    <ul>
      <li><strong>Rows:</strong> {{ overview.rows }}</li>
      <li><strong>Columns:</strong> {{ overview.columns }}</li>
      <li><strong>Numeric ranges:</strong> {{ overview.numeric_ranges | length }} columns</li>
    </ul>

    <h2>Shapes</h2>
    <ul>
      <li><strong>Session-level table:</strong> {{ session_shape[0] }} rows × {{ session_shape[1] }} columns</li>
      <li><strong>User-level table:</strong> {{ user_shape[0] }} rows × {{ user_shape[1] }} columns</li>
    </ul>

    <h2>Missingness</h2>
    <div class="grid">
      <div>
        <h3>Session-level (top missing)</h3>
        <table>
          <thead>
            <tr><th>column</th><th>missing</th><th>missing_pct</th><th>dtype</th></tr>
          </thead>
          <tbody>
            {% for r in session_missing[:25] %}
              <tr>
                <td>{{ r.column }}</td>
                <td>{{ r.missing }}</td>
                <td>{{ r.missing_pct }}</td>
                <td>{{ r.dtype }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div>
        <h3>User-level (top missing)</h3>
        <table>
          <thead>
            <tr><th>column</th><th>missing</th><th>missing_pct</th><th>dtype</th></tr>
          </thead>
          <tbody>
            {% for r in user_missing[:25] %}
              <tr>
                <td>{{ r.column }}</td>
                <td>{{ r.missing }}</td>
                <td>{{ r.missing_pct }}</td>
                <td>{{ r.dtype }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <h2>Validity & consistency checks</h2>
    {% if validation_summary %}
      <table>
        <thead>
          <tr>
            <th>check</th>
            <th>type</th>
            <th>details</th>
            <th>invalid_count</th>
            <th>decision</th>
            <th>action</th>
            <th>rationale</th>
          </tr>
        </thead>
        <tbody>
          {% for r in validation_summary %}
            <tr>
              <td>{{ r.check }}</td>
              <td>{{ r.type }}</td>
              <td>{{ r.details }}</td>
              <td>{{ r.invalid_count }}</td>
              <td>{{ r.decision }}</td>
              <td>{{ r.action }}</td>
              <td>{{ r.rationale }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No validity checks recorded for this run.</p>
    {% endif %}

    <h2>Descriptive statistics</h2>
    <div class="grid">
      <div>
        <h3>Session-level (numeric)</h3>
        <table>
          <thead>
            <tr><th>column</th><th>mean</th><th>median</th><th>min</th><th>max</th><th>std</th></tr>
          </thead>
          <tbody>
            {% for r in session_stats[:25] %}
              <tr>
                <td>{{ r.column }}</td>
                <td>{{ r.mean }}</td>
                <td>{{ r.median }}</td>
                <td>{{ r.min }}</td>
                <td>{{ r.max }}</td>
                <td>{{ r.std }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div>
        <h3>User-level (numeric)</h3>
        <table>
          <thead>
            <tr><th>column</th><th>mean</th><th>median</th><th>min</th><th>max</th><th>std</th></tr>
          </thead>
          <tbody>
            {% for r in user_stats[:25] %}
              <tr>
                <td>{{ r.column }}</td>
                <td>{{ r.mean }}</td>
                <td>{{ r.median }}</td>
                <td>{{ r.min }}</td>
                <td>{{ r.max }}</td>
                <td>{{ r.std }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <h2>Core charts</h2>
    <div class="grid">
      <!-- Notes: Charts are base64 images embedded by the renderer (no external files required). -->
      {% for key, img in charts.items() %}
        <div class="chart">
          <div class="muted"><code>{{ key }}</code></div>
          <img src="data:image/png;base64,{{ img }}" style="max-width:100%" />
        </div>
      {% endfor %}
    </div>

    <h2>Exploratory transformations</h2>
    <p class="muted">
      Exploratory scaling and feature derivations only; downstream artifacts remain unchanged.
      Machine-readable output: <code>{{ transform_experiments.artifact_path }}</code>
    </p>

    <h3>Scaling summaries</h3>
    {% if transform_experiments.scaling_summary %}
      <table>
        <thead>
          <tr>
            <th>column</th>
            <th>before mean</th>
            <th>before std</th>
            <th>before skew</th>
            <th>standard mean</th>
            <th>standard std</th>
            <th>standard skew</th>
            <th>min-max mean</th>
            <th>min-max std</th>
            <th>min-max skew</th>
          </tr>
        </thead>
        <tbody>
          {% for r in transform_experiments.scaling_summary %}
            <tr>
              <td>{{ r.column }}</td>
              <td>{{ r.before.mean }}</td>
              <td>{{ r.before.std }}</td>
              <td>{{ r.before.skew }}</td>
              <td>{{ r.standard_scaled.mean }}</td>
              <td>{{ r.standard_scaled.std }}</td>
              <td>{{ r.standard_scaled.skew }}</td>
              <td>{{ r.minmax_scaled.mean }}</td>
              <td>{{ r.minmax_scaled.std }}</td>
              <td>{{ r.minmax_scaled.skew }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No scaling summaries available for this run.</p>
    {% endif %}

    <h3>Candidate feature derivations</h3>
    {% if transform_experiments.feature_derivations %}
      <table>
        <thead>
          <tr>
            <th>feature</th>
            <th>description</th>
            <th>skew before</th>
            <th>skew after</th>
            <th>delta skew</th>
            <th>top correlations</th>
          </tr>
        </thead>
        <tbody>
          {% for r in transform_experiments.feature_derivations %}
            <tr>
              <td>{{ r.name }}</td>
              <td>{{ r.description }}</td>
              <td>{{ r.distribution_shift.skew_before }}</td>
              <td>{{ r.distribution_shift.skew_after }}</td>
              <td>{{ r.distribution_shift.delta_skew }}</td>
              <td>
                {% if r.top_correlations %}
                  {% for corr in r.top_correlations %}
                    {{ corr.column }} ({{ corr.corr }}){% if not loop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="muted">n/a</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No feature derivations evaluated.</p>
    {% endif %}

    <h2>Exploratory clustering (hypotheses only)</h2>
    <p class="muted">
      Clusters in this section are exploratory hypotheses and <strong>not</strong> production outputs.
      Machine-readable output: <code>{{ clustering_exploration.artifact_path }}</code>
    </p>
    {% if clustering_exploration.status == "completed" %}
      <ul>
        <li><strong>Source table:</strong> {{ clustering_exploration.source_table }}</li>
        <li><strong>Rows used:</strong> {{ clustering_exploration.n_rows }}{% if clustering_exploration.sampled %} (sampled) {% endif %}</li>
        <li><strong>Feature count:</strong> {{ clustering_exploration.n_features }}</li>
        <li><strong>Selection criteria:</strong> max missing {{ clustering_exploration.feature_criteria.max_missing_pct }},
          min unique {{ clustering_exploration.feature_criteria.min_unique }},
          imputation {{ clustering_exploration.feature_criteria.imputation }},
          scaling {{ clustering_exploration.feature_criteria.scaling }}</li>
      </ul>
      <p class="muted">
        Candidate features: {{ clustering_exploration.feature_columns | join(', ') }}
      </p>
      <ul>
        <li><strong>K-Means metrics:</strong> <code>{{ clustering_exploration.artifacts.kmeans_metrics_csv }}</code></li>
        <li><strong>DBSCAN metrics:</strong> <code>{{ clustering_exploration.artifacts.dbscan_metrics_csv }}</code></li>
      </ul>

      <h3>K-Means trials</h3>
      {% if clustering_exploration.kmeans.metrics %}
        <table>
          <thead>
            <tr><th>k</th><th>inertia</th><th>silhouette</th><th>label_count</th></tr>
          </thead>
          <tbody>
            {% for r in clustering_exploration.kmeans.metrics %}
              <tr>
                <td>{{ r.k }}</td>
                <td>{{ r.inertia }}</td>
                <td>{{ r.silhouette }}</td>
                <td>{{ r.label_count }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">No K-Means metrics available.</p>
      {% endif %}
      {% if clustering_exploration.plots.kmeans %}
        <div class="chart">
          <div class="muted"><code>{{ clustering_exploration.plots.kmeans.path }}</code></div>
          <img src="data:image/png;base64,{{ clustering_exploration.plots.kmeans.base64 }}" style="max-width:100%" />
        </div>
      {% endif %}

      <h3>DBSCAN trials</h3>
      {% if clustering_exploration.dbscan.metrics %}
        <table>
          <thead>
            <tr><th>eps</th><th>min_samples</th><th>n_clusters</th><th>noise_ratio</th></tr>
          </thead>
          <tbody>
            {% for r in clustering_exploration.dbscan.metrics %}
              <tr>
                <td>{{ r.eps }}</td>
                <td>{{ r.min_samples }}</td>
                <td>{{ r.n_clusters }}</td>
                <td>{{ r.noise_ratio }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">No DBSCAN metrics available.</p>
      {% endif %}
      {% if clustering_exploration.plots.dbscan %}
        <div class="chart">
          <div class="muted"><code>{{ clustering_exploration.plots.dbscan.path }}</code></div>
          <img src="data:image/png;base64,{{ clustering_exploration.plots.dbscan.base64 }}" style="max-width:100%" />
        </div>
      {% endif %}
    {% else %}
      <p class="muted">{{ clustering_exploration.reason }}</p>
    {% endif %}

    <h2>Relationship analysis</h2>
    <table>
      <thead>
        <tr><th>column A</th><th>column B</th><th>|corr|</th></tr>
      </thead>
      <tbody>
        {% for r in correlations %}
          <tr>
            <td>{{ r.col_a }}</td>
            <td>{{ r.col_b }}</td>
            <td>{{ r.corr }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <h2>Key insights</h2>
    <ul>
      {% for insight in key_insights %}
        <li>{{ insight }}</li>
      {% endfor %}
    </ul>

    <h2>Hypothesis generation</h2>
    <ul>
      {% for hypothesis in hypotheses %}
        <li>{{ hypothesis }}</li>
      {% endfor %}
    </ul>

    <h2>Data previews</h2>
    <h3>Session-level sample</h3>
    <!-- Notes: Preview is escaped HTML table produced by pandas; safe to embed. -->
    {{ session_sample | safe }}

    <h3>User-level sample</h3>
    {{ user_sample | safe }}
  </body>
</html>
